'use client';

import React, { useState, useEffect, useRef } from 'react';
import { 
  motion, 
  useScroll, 
  useTransform, 
  useSpring, 
  useInView, 
  AnimatePresence,
  useMotionValueEvent
} from 'framer-motion';
import {
  Download, Calendar, MapPin, Users, BookOpen,
  Megaphone, ShieldCheck, Instagram, Globe, Mail,
  ArrowRight, Sparkles, Zap, Asterisk, ArrowDown,
  BarChart3, ChevronDown, ChevronUp, ExternalLink,
  Menu, X, Trophy, Loader2
} from 'lucide-react';
import { createClient } from '@/utils/supabase/client'; // ‚ö†Ô∏è Ensure this path is correct

// --- CONFIGURATION ---

// Keep Live Updates static for now (unless you create an announcements table later)
const LIVE_UPDATES = [
  "üì¢ Registration closes in 2 hours for Off-stage events.",
  "üèÜ Junior Essay Writing Results Published - Check Leaderboard.",
  "üìç Senior Debate (Prelims) starting at Auditorium A at 2:00 PM.",
  "‚ú® 'Huwa Allah' - Recognition to Expression.",
  "‚ö°Ô∏è Stage 2 Schedule Released."
];

// Committee List (Static)
const COMMITTEE = [
  { role: "Controller", name: "Ustad Sayyid Adil Hassan Wafy", image: "" },
  { role: "Asst. Controller", name: "Ustad Sajid Wafy", image: "" },
  { role: "Chairman", name: "Ziyad Hussain", image: "" },
  { role: "General Convenor", name: "Nabeel Muhammed", image: "" },
  { role: "Deputy Convenor", name: "Ishaq PC", image: "" },
  { role: "Asst. Convenor", name: "Rashid CP", image: "" },
];

// Team Configuration for Colors (Fallback)
const TEAM_CONFIG: Record<string, string> = {
  'GR1': '#3b82f6', // Hormuz - Blue
  'GR2': '#10b981', // Aden - Emerald
  'GR3': '#ef4444', // Zanzibar - Red
  'GR4': '#f59e0b', // Malacca - Amber
};

// --- COMPONENTS ---

const NoiseOverlay = () => (
  <div className="fixed inset-0 pointer-events-none z-50 opacity-[0.03] mix-blend-overlay">
    <svg className="w-full h-full">
      <filter id="noise">
        <feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="3" stitchTiles="stitch" />
      </filter>
      <rect width="100%" height="100%" filter="url(#noise)" />
    </svg>
  </div>
);

const StickyNavbar = () => {
  const [hidden, setHidden] = useState(false);
  const [scrolled, setScrolled] = useState(false);
  const { scrollY } = useScroll();
  const lastScrollY = useRef(0);

  useMotionValueEvent(scrollY, "change", (latest) => {
    const diff = latest - lastScrollY.current;
    if (Math.abs(diff) > 20) { 
      setHidden(diff > 0 && latest > 100);
      setScrolled(latest > 50);
      lastScrollY.current = latest;
    }
  });

  return (
    <motion.nav
      variants={{
        visible: { y: 0 },
        hidden: { y: "-100%" },
      }}
      animate={hidden ? "hidden" : "visible"}
      transition={{ duration: 0.35, ease: "easeInOut" }}
      className={`fixed top-0 left-0 w-full z-40 px-6 py-4 flex justify-between items-center transition-colors duration-300 ${
        scrolled ? "bg-white/80 backdrop-blur-md border-b border-gray-100 text-slate-900" : "bg-transparent text-white"
      }`}
    >
      <span className="font-bold text-xl tracking-widest flex items-center gap-2">
        <Sparkles className={`w-5 h-5 ${scrolled ? 'text-[#0033A0]' : 'text-yellow-400'}`} />
        QUL.
      </span>
      <div className="flex gap-4">
         {/* Add navigation links here if needed */}
         <button className={`px-4 py-1.5 rounded-full border text-xs font-bold uppercase tracking-wider transition-all ${
           scrolled 
             ? "border-slate-200 bg-slate-100 text-slate-900 hover:bg-[#0033A0] hover:text-white" 
             : "border-white/20 bg-white/10 text-white hover:bg-white hover:text-[#0033A0]"
         }`}>
           Live Results
         </button>
      </div>
    </motion.nav>
  );
};

// --- MAIN PAGE ---

export default function App() {
  const supabase = createClient();
  const containerRef = useRef(null);

  // State for Dynamic Data
  const [leaderboard, setLeaderboard] = useState<any[]>([]);
  const [recentResults, setRecentResults] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);

  // --- DATA FETCHING ---
  useEffect(() => {
    const fetchDashboardData = async () => {
      try {
        // 1. Fetch Raw Data in Parallel (Robust Manual Join Method)
        const [teamsRes, eventsRes, studentsRes, resultsRes] = await Promise.all([
          supabase.from('teams').select('*'),
          supabase.from('events').select('*'),
          supabase.from('students').select('id, name'),
          supabase.from('results').select('*').eq('published', true).order('created_at', { ascending: false })
        ]);

        if (teamsRes.error || resultsRes.error) throw new Error("Data fetch failed");

        const teamsData = teamsRes.data || [];
        const resultsData = resultsRes.data || [];
        const eventsData = eventsRes.data || [];
        const studentsData = studentsRes.data || [];

        // Create Lookups
        const teamMap: Record<string, any> = {};
        teamsData.forEach((t: any) => teamMap[t.id] = t);
        
        const eventMap: Record<string, any> = {};
        eventsData.forEach((e: any) => eventMap[e.id] = e);

        const studentMap: Record<string, string> = {};
        studentsData.forEach((s: any) => studentMap[s.id] = s.name);

        // 2. Calculate Leaderboard
        const scores: Record<string, number> = {};
        teamsData.forEach((t: any) => scores[t.id] = 0);

        resultsData.forEach((r: any) => {
           if (r.team_id && scores[r.team_id] !== undefined) {
             scores[r.team_id] += (r.points || 0);
           }
        });

        const leaderboardData = teamsData.map((t: any) => ({
          id: t.id,
          name: t.name,
          score: scores[t.id],
          // Use hex from DB, or fallback to config
          color: t.color_hex || TEAM_CONFIG[t.slug] || '#64748b' 
        })).sort((a: any, b: any) => b.score - a.score);

        setLeaderboard(leaderboardData);

        // 3. Process Recent Results (Top 4)
        const processedResults = resultsData.slice(0, 4).map((r: any) => {
           const event = eventMap[r.event_id];
           const team = teamMap[r.team_id];
           // Determine winner name (Student or Team)
           let winner = "Unknown";
           if (r.student_id && studentMap[r.student_id]) winner = studentMap[r.student_id];
           else if (team) winner = team.name;

           // Calculate time ago (simple version)
           const diffInMinutes = Math.floor((new Date().getTime() - new Date(r.created_at).getTime()) / 60000);
           let timeString = "Just now";
           if (diffInMinutes > 0) timeString = `${diffInMinutes}m ago`;
           if (diffInMinutes > 60) timeString = `${Math.floor(diffInMinutes/60)}h ago`;
           if (diffInMinutes > 1440) timeString = `${Math.floor(diffInMinutes/1440)}d ago`;

           return {
             id: r.id,
             event: event ? `${event.name}` : "Unknown Event",
             category: event?.category || '',
             winner: winner,
             team: team ? team.name : "",
             teamColor: team?.color_hex || '#94a3b8',
             points: r.points,
             time: timeString
           };
        });

        setRecentResults(processedResults);

      } catch (err) {
        console.error("Fetch Error:", err);
      } finally {
        setLoading(false);
      }
    };

    fetchDashboardData();
  }, []);

  return (
    <main className="min-h-screen bg-slate-50 font-sans selection:bg-[#0033A0] selection:text-white overflow-x-hidden">
      <NoiseOverlay />
      <StickyNavbar />

      {/* --- HERO SECTION --- */}
      <section className="relative h-screen w-full bg-[#0033A0] text-white overflow-hidden flex flex-col justify-center items-center">
        {/* Background Gradients */}
        <div className="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20 brightness-100 contrast-100 mix-blend-overlay"></div>
        <div className="absolute top-0 right-0 w-[500px] h-[500px] bg-purple-500 rounded-full blur-[120px] opacity-30 animate-pulse"></div>
        <div className="absolute bottom-0 left-0 w-[600px] h-[600px] bg-blue-400 rounded-full blur-[140px] opacity-20"></div>

        {/* Content */}
        <div className="relative z-10 text-center px-4 max-w-4xl mx-auto space-y-6">
           <motion.div 
             initial={{ opacity: 0, y: 20 }}
             animate={{ opacity: 1, y: 0 }}
             transition={{ duration: 0.8 }}
             className="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-white/20 bg-white/5 backdrop-blur-sm text-xs font-bold uppercase tracking-widest text-blue-200 mb-4"
           >
             <Zap className="w-3 h-3 text-yellow-400" />
             Arts Fest '26
           </motion.div>

           <motion.h1 
             initial={{ opacity: 0, scale: 0.9 }}
             animate={{ opacity: 1, scale: 1 }}
             transition={{ duration: 0.8, delay: 0.2 }}
             className="text-6xl md:text-9xl font-black tracking-tighter leading-none"
           >
             QUL<span className="text-yellow-400">.</span>
           </motion.h1>

           <motion.p 
             initial={{ opacity: 0 }}
             animate={{ opacity: 1 }}
             transition={{ duration: 0.8, delay: 0.4 }}
             className="text-lg md:text-2xl text-blue-100 font-medium max-w-2xl mx-auto leading-relaxed"
           >
             The ultimate celebration of art, culture, and talent at <br className="hidden md:block"/> PMSA Wafy College.
           </motion.p>
        </div>

        {/* Live Updates Marquee */}
        <div className="absolute bottom-0 w-full bg-black/20 backdrop-blur-md border-t border-white/10 overflow-hidden py-3">
          <motion.div 
            className="flex gap-12 whitespace-nowrap text-sm font-medium text-blue-100"
            animate={{ x: ["100%", "-100%"] }}
            transition={{ duration: 30, repeat: Infinity, ease: "linear" }}
          >
             {LIVE_UPDATES.map((update, i) => (
               <span key={i} className="flex items-center gap-2">
                 <Asterisk className="w-3 h-3 text-yellow-400" /> {update}
               </span>
             ))}
          </motion.div>
        </div>
      </section>

      {/* --- LIVE DASHBOARD SECTION --- */}
      <section ref={containerRef} className="py-20 px-6 container mx-auto relative z-20 -mt-10">
        <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
          
          {/* LEADERBOARD CARD */}
          <motion.div 
            initial={{ opacity: 0, y: 20 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true }}
            className="lg:col-span-8 bg-white rounded-3xl p-8 shadow-xl border border-slate-100 relative overflow-hidden"
          >
             <div className="absolute top-0 right-0 p-6 opacity-5">
               <BarChart3 className="w-48 h-48 text-[#0033A0]" />
             </div>

             <div className="flex items-center justify-between mb-8 relative z-10">
               <div>
                 <h2 className="text-2xl font-bold flex items-center gap-2">
                   <Trophy className="w-6 h-6 text-yellow-500" /> Live Standings
                 </h2>
                 <p className="text-slate-500 text-sm mt-1">Real-time point tracking</p>
               </div>
               <div className="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1 animate-pulse">
                 <div className="w-2 h-2 bg-green-500 rounded-full"></div> LIVE
               </div>
             </div>

             <div className="space-y-4 relative z-10">
               {loading ? (
                 <div className="flex flex-col items-center justify-center py-10 text-slate-400">
                    <Loader2 className="w-8 h-8 animate-spin mb-2 text-blue-600"/>
                    <p>Loading Scores...</p>
                 </div>
               ) : (
                 leaderboard.map((team, index) => (
                   <div key={team.id} className="group relative">
                      <div className="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100 group-hover:border-blue-200 transition-all">
                        <div className="flex items-center gap-4">
                           <div className="w-8 h-8 flex items-center justify-center font-black text-slate-300 text-lg">
                             {index + 1}
                           </div>
                           <div className="w-3 h-12 rounded-full" style={{ backgroundColor: team.color }}></div>
                           <div>
                             <h3 className="font-bold text-lg text-slate-800">{team.name}</h3>
                             <p className="text-xs text-slate-500 font-medium uppercase tracking-wider">Group {index + 1}</p>
                           </div>
                        </div>
                        <div className="text-right">
                           <div className="text-3xl font-black text-[#0033A0]">{team.score}</div>
                           <div className="text-xs font-bold text-slate-400">POINTS</div>
                        </div>
                      </div>
                      {/* Progress Bar Visual */}
                      <div className="absolute bottom-0 left-0 h-1 bg-slate-200 w-full rounded-b-2xl overflow-hidden">
                        <motion.div 
                          initial={{ width: 0 }}
                          whileInView={{ width: `${(team.score / (leaderboard[0]?.score || 1)) * 100}%` }}
                          transition={{ duration: 1.5, ease: "circOut" }}
                          className="h-full"
                          style={{ backgroundColor: team.color }}
                        />
                      </div>
                   </div>
                 ))
               )}
             </div>
          </motion.div>

          {/* LATEST RESULTS CARD */}
          <motion.div 
             initial={{ opacity: 0, y: 20 }}
             whileInView={{ opacity: 1, y: 0 }}
             viewport={{ once: true }}
             transition={{ delay: 0.1 }}
             className="lg:col-span-4 bg-[#0033A0] text-white rounded-3xl p-8 shadow-xl relative overflow-hidden flex flex-col"
          >
             <div className="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full blur-3xl -mr-16 -mt-16"></div>
             
             <h2 className="text-2xl font-bold mb-6 flex items-center gap-2 relative z-10">
               <Zap className="w-6 h-6 text-yellow-400" /> Latest Results
             </h2>

             <div className="space-y-4 flex-1 overflow-y-auto pr-2 relative z-10">
               {loading ? (
                 <div className="text-white/50 text-center py-10">Updating feed...</div>
               ) : recentResults.length === 0 ? (
                 <div className="text-white/50 text-center py-10">No results published yet.</div>
               ) : (
                 recentResults.map((result, i) => (
                   <div key={i} className="bg-white/10 backdrop-blur-md rounded-xl p-4 border border-white/10">
                      <div className="flex justify-between items-start mb-2">
                        <span className="text-[10px] font-bold uppercase tracking-widest text-blue-200 bg-black/20 px-2 py-0.5 rounded">
                          {result.category}
                        </span>
                        <span className="text-xs text-blue-200">{result.time}</span>
                      </div>
                      <h4 className="font-bold text-lg leading-tight mb-1">{result.event}</h4>
                      <div className="flex items-center gap-2 mt-2">
                        <div className="w-2 h-2 rounded-full" style={{ backgroundColor: result.teamColor }}></div>
                        <span className="text-sm font-medium text-white/90">
                           {result.winner} <span className="text-white/50 text-xs">({result.team})</span>
                        </span>
                      </div>
                   </div>
                 ))
               )}
             </div>

             <button className="mt-6 w-full py-3 rounded-xl bg-white text-[#0033A0] font-bold text-sm hover:bg-blue-50 transition-colors flex items-center justify-center gap-2">
               View All Results <ArrowRight className="w-4 h-4" />
             </button>
          </motion.div>

        </div>
      </section>

      {/* --- FOOTER (Static) --- */}
      <footer className="bg-slate-900 text-slate-400 py-12 px-6 border-t border-slate-800">
        <div className="container mx-auto">
          <div className="flex flex-col md:flex-row justify-between items-center pt-8 border-t border-white/5 text-xs text-gray-600">
            <p>¬© 2026 PMSA Wafy College. All rights reserved.</p>
            <div className="flex items-center gap-2 mt-4 md:mt-0">
              <span>Designed with</span>
              <span className="text-red-500">‚ù§</span>
              <span>by SINAN AK</span>
            </div>
          </div>
        </div>
      </footer>
    </main>
  );
}